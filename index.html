<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Link ile Grup Voice Chat</title>
<style>
body { font-family: sans-serif; text-align: center; margin-top: 50px; }
button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px; }
audio { display: block; margin: 10px auto; width: 300px; }
#link { margin-top: 20px; word-break: break-all; }
</style>
</head>
<body>

<h1>Link ile Grup Voice Chat</h1>
<button id="joinBtn">Odaya Katıl / Oda Oluştur</button>
<div id="link"></div>
<div id="audios"></div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
const joinBtn = document.getElementById('joinBtn');
const audiosDiv = document.getElementById('audios');
const linkDiv = document.getElementById('link');

let localStream;
let peer;
let connections = {};

// URL’den room al
let urlParams = new URLSearchParams(window.location.search);
let roomId = urlParams.get('room');
if (!roomId) roomId = Math.random().toString(36).substring(2, 10); // rastgele oda

async function initPeer() {
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

  peer = new Peer(undefined, { debug: 2 });

  peer.on('open', id => {
    linkDiv.innerHTML = `Oda linki: <a href="?room=${roomId}" target="_blank">${window.location.origin}?room=${roomId}</a>`;

    joinRoom(id);
  });

  peer.on('call', incomingCall => {
    incomingCall.answer(localStream);
    incomingCall.on('stream', remoteStream => addAudio(remoteStream, incomingCall.peer));
  });
}

function addAudio(stream, peerId) {
  if (document.getElementById('audio-' + peerId)) return;
  const audio = document.createElement('audio');
  audio.id = 'audio-' + peerId;
  audio.autoplay = true;
  audio.srcObject = stream;
  audiosDiv.appendChild(audio);
}

function joinRoom(myId) {
  // Basit demo için localStorage kullanıyoruz
  let peers = JSON.parse(localStorage.getItem('room-' + roomId) || "[]");

  peers.forEach(peerId => {
    const call = peer.call(peerId, localStream);
    call.on('stream', remoteStream => addAudio(remoteStream, peerId));
    connections[peerId] = call;
  });

  if (!peers.includes(myId)) peers.push(myId);
  localStorage.setItem('room-' + roomId, JSON.stringify(peers));
}

joinBtn.onclick = initPeer;
</script>
</body>
</html>
