<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tost Chat v2 Ultra — Midnight</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1: #08040a;
      --bg-2: #0c0820;
      --card: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.025);
      --accent-1: #7b3fb3;
      --accent-2: #3b1f63;
      --muted: #a99fc0;
      --text: #eae7f6;
      --bubble-me-start: rgba(140,86,217,0.95);
      --bubble-me-end: rgba(92,43,152,0.95);
      --bubble-other: rgba(255,255,255,0.04);
      --radius: 14px;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    /* App centering */
    .app {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }

    /* Shell */
    .shell {
      width:100%;
      max-width:1100px;
      height:86vh;
      border-radius:18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      backdrop-filter: blur(8px) saturate(120%);
    }

    /* Left Sidebar */
    .sidebar {
      padding:20px;
      background: linear-gradient(180deg, rgba(127,82,255,0.03), rgba(0,0,0,0.02));
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:52px;height:52px;border-radius:12px;
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      display:flex;align-items:center;justify-content:center;font-weight:800;
      color:white;font-size:20px;box-shadow: 0 10px 30px rgba(91, 41, 148, 0.22);
    }
    .brand h1 { margin:0;font-size:18px; }
    .brand p { margin:0;font-size:12px;color:var(--muted); }

    /* AUTH CARD in sidebar (keeps small on wide, modal on mobile) */
    .auth-card {
      margin-top:6px;padding:14px;border-radius:12px;background:var(--card);border:1px solid rgba(255,255,255,0.02);
      display:flex;flex-direction:column;gap:10px;
    }
    .auth-card label { font-size:13px;color:var(--muted); }
    .auth-card input[type="password"], .auth-card input[type="text"]{
      padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      background: rgba(0,0,0,0.14); color:var(--text); outline:none; font-size:14px;
    }
    .auth-card .btn {
      margin-top:6px;padding:10px;border-radius:10px;border:none;
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      color:white;font-weight:700; cursor:pointer; box-shadow: 0 10px 30px rgba(123,63,179,0.18);
    }
    .auth-card .hint { font-size:12px;color:var(--muted); }

    .sidebar-footer { margin-top:auto;font-size:13px;color:var(--muted); }

    /* Chat column */
    .chat {
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:18px;
    }

    .topbar {
      display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.02);
    }
    .top-left { display:flex;align-items:center;gap:12px; }
    .avatar {
      width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#a86fe0,#5a2f8a);
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:18px;
    }
    .meta .name { font-weight:700; }
    .meta .subtitle { font-size:12px;color:var(--muted); }

    /* Messages area */
    .messages {
      flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:12px;
      background-image: radial-gradient(circle at 10% 10%, rgba(255,255,255,0.01), transparent 8%), radial-gradient(circle at 90% 90%, rgba(255,255,255,0.01), transparent 8%);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.01);
    }

    .msg-row { display:flex; gap:10px; align-items:flex-end; max-width:75%; }
    .msg-row.me { margin-left:auto; justify-content:flex-end; }
    .bubble {
      padding:12px 14px; border-radius:12px; font-size:14px; line-height:1.35; position:relative; max-width:100%;
      box-shadow: 0 8px 26px rgba(0,0,0,0.45);
      transform-origin: bottom right;
      animation: pop .16s ease;
    }
    .bubble .who { font-size:12px;color:var(--muted); margin-bottom:6px; }
    .bubble .text { white-space:pre-wrap; word-break:break-word; }
    .bubble .time { display:block; font-size:11px; color:var(--muted); margin-top:8px; text-align:right; }

    .bubble.other { background: var(--bubble-other); color:var(--text); border:1px solid rgba(255,255,255,0.02); border-top-left-radius:5px; }
    .bubble.me { background: linear-gradient(135deg,var(--bubble-me-start),var(--bubble-me-end)); color:white; border:1px solid rgba(255,255,255,0.04); border-top-right-radius:5px; }

    @keyframes pop { from { transform: scale(.985); opacity:0 } to { transform: scale(1); opacity:1 } }

    /* small avatar for other messages */
    .avatar-sm { width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7b4dc1,#2f1d58);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:13px; }

    /* Input area */
    .composer {
      display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02);
    }
    .composer textarea {
      min-height:48px; max-height:140px; resize:none; flex:1; padding:12px;border-radius:12px;border:none;background:transparent;color:var(--text);outline:none;font-size:15px;
    }
    .send {
      padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,#b071f2,#5f36a9);color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(103,51,148,0.18);
      transition: transform .12s ease;
    }
    .send:active { transform: translateY(1px) scale(.995); }

    .typing-indicator { font-size:13px;color:var(--muted); padding-left:6px; }

    .empty { text-align:center;color:var(--muted); margin-top:30px; }

    /* small screens */
    @media (max-width:900px) {
      .shell { grid-template-columns: 1fr; height:100vh; border-radius:0; max-width:100%; }
      .sidebar { display:none; }
      .chat { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">

      <!-- SIDEBAR (Auth + name input kept here for large screens) -->
      <aside class="sidebar" aria-hidden="false">
        <div class="brand">
          <div class="logo">TØ</div>
          <div>
            <h1>Tost Chat</h1>
            <p>Midnight — v2 Ultra</p>
          </div>
        </div>

        <div class="auth-card" id="sidebarAuth">
          <label for="secretInput">Doğrulama (giriş için)</label>
          <input id="secretInput" type="password" placeholder="Doğrulama kelimesini gir" autocomplete="off" />
          <label for="nameInput">Sohbette gözükecek adın</label>
          <input id="nameInput" type="text" placeholder="Takma ad (ör. Emre)" autocomplete="off" />
          <button id="enterBtn" class="btn">Giriş Yap</button>
          <div class="hint">Doğrulama kelimesi: <strong>8btost</strong></div>
        </div>

        <div class="sidebar-footer">Made with ❤️ — Tost Team</div>
      </aside>

      <!-- CHAT AREA -->
      <section class="chat" role="main" aria-live="polite">
        <div class="topbar" id="topbar" aria-hidden="false">
          <div class="top-left">
            <div class="avatar" id="topAvatar">T</div>
            <div class="meta">
              <div class="name" id="topName">Tost Chat</div>
              <div class="subtitle" id="topSubtitle">Güzel sohbetler başlasın</div>
            </div>
          </div>
          <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
            <div class="typing-indicator" id="typingIndicator" style="display:none;">...</div>
          </div>
        </div>

        <div class="messages" id="messages">
          <div class="empty" id="emptyHint">Sohbete başlamak için giriş yapın.</div>
        </div>

        <div class="composer" id="composer" style="display:none;">
          <textarea id="msgInput" placeholder="Mesaj yaz... (Enter = gönder)" aria-label="Mesaj gir"></textarea>
          <button class="send" id="sendBtn" aria-label="Gönder">Gönder</button>
        </div>
      </section>

    </div>
  </div>

  <script type="module">
    /* ====== Firebase imports ====== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, query, orderByChild, set, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /* ====== UI elements ====== */
    const secretInput = document.getElementById('secretInput');
    const nameInput = document.getElementById('nameInput');
    const enterBtn = document.getElementById('enterBtn');
    const messagesEl = document.getElementById('messages');
    const composer = document.getElementById('composer');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const topAvatar = document.getElementById('topAvatar');
    const topName = document.getElementById('topName');
    const topSubtitle = document.getElementById('topSubtitle');
    const typingIndicator = document.getElementById('typingIndicator');
    const emptyHint = document.getElementById('emptyHint');
    const sidebarAuth = document.getElementById('sidebarAuth');

    /* ====== Config & state ====== */
    const SECRET = "8btost";
    let DISPLAY_NAME = "";
    let USER_KEY = ""; // unique key for typing status / presence
    let db = null;
    let messagesRef = null;
    let typingRef = null;
    let typingTimer = null;

    /* ====== Utilities ====== */
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c] )); }
    function avatarLetter(name){ return (name||'T').trim().charAt(0).toUpperCase(); }
    function nowTs(){ return Date.now(); }
    function formatTime(ts){
      if(!ts) return '';
      const d = new Date(Number(ts));
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const today = new Date();
      if (d.toDateString() === today.toDateString()) return `${hh}:${mm}`;
      const dd = String(d.getDate()).padStart(2,'0');
      const mo = String(d.getMonth()+1).padStart(2,'0');
      return `${dd}.${mo} ${hh}:${mm}`;
    }

    /* ====== Init Firebase when user enters ====== */
    enterBtn.addEventListener('click', onEnter);
    secretInput.addEventListener('keydown', e => { if(e.key==='Enter') onEnter(); });
    nameInput.addEventListener('keydown', e => { if(e.key==='Enter') onEnter(); });

    function onEnter(){
      const secret = secretInput.value.trim();
      const name = nameInput.value.trim() || ("Kullanıcı-" + Math.floor(Math.random()*9000 + 100));
      if(secret !== SECRET){
        // subtle shake and return
        sidebarAuth.animate([{ transform: 'translateX(-6px)' }, { transform: 'translateX(6px)' }, { transform: 'translateX(0)' }], { duration: 260 });
        alert('Yanlış doğrulama kelimesi!');
        return;
      }
      DISPLAY_NAME = name;
      USER_KEY = 'u_' + Math.random().toString(36).slice(2,9);

      // update topbar
      topAvatar.textContent = avatarLetter(DISPLAY_NAME);
      topName.textContent = DISPLAY_NAME;
      topSubtitle.textContent = 'Sohbete hoşgeldin — ' + DISPLAY_NAME;

      // hide sidebar auth (on small screens it was hidden anyway)
      sidebarAuth.style.display = 'none';

      // show composer & init firebase
      composer.style.display = 'flex';
      emptyHint.style.display = 'none';

      initFirebaseAndChat();
      setTimeout(()=> msgInput.focus(), 250);
    }

    /* ====== Firebase setup & realtime handlers ====== */
    function initFirebaseAndChat(){
      const firebaseConfig = {
        apiKey: "AIzaSyDag_mCdG-tvvbZ3Dz7bpj9pbjh5teskg8",
        authDomain: "tost-269b0.firebaseapp.com",
        databaseURL: "https://tost-269b0-default-rtdb.firebaseio.com",
        projectId: "tost-269b0",
        storageBucket: "tost-269b0.firebasestorage.app",
        messagingSenderId: "882411853999",
        appId: "1:882411853999:web:8a0eb7a9b12d3df6b2dc5a",
        measurementId: "G-12KF7R4YME"
      };

      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);

      messagesRef = ref(db, 'messages');
      typingRef = ref(db, 'typing');

      // load existing messages in order (we rely on onChildAdded with query)
      const ordered = query(messagesRef, orderByChild('ts'));

      onChildAdded(ordered, snap => {
        const data = snap.val();
        addMessageToDOM(data);
      });

      // typing presence listener
      onValue(typingRef, snap => {
        const obj = snap.val() || {};
        // if any other user is typing, show indicator
        const othersTyping = Object.keys(obj).filter(k => (k !== USER_KEY) && obj[k] === true);
        if(othersTyping.length > 0){
          typingIndicator.style.display = 'inline-block';
          typingIndicator.textContent = `${othersTyping.length > 1 ? 'Birden fazla kişi yazıyor...' : 'Bir kullanıcı yazıyor...'}`;
        } else {
          typingIndicator.style.display = 'none';
        }
      });

      // send handlers
      sendBtn.addEventListener('click', sendMessage);
      msgInput.addEventListener('keydown', e => {
        if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
        // typing indicator toggle
        markTyping();
      });
      msgInput.addEventListener('input', markTyping);
    }

    /* ====== Typing logic (sets /typing/<USER_KEY> = true/false) ====== */
    function markTyping(){
      if(!db || !typingRef) return;
      // set typing true
      const path = ref(db, 'typing/' + USER_KEY);
      set(path, true).catch(()=>{});
      // ensure removal on disconnect if supported
      try{
        onDisconnect(path).remove().catch(()=>{});
      } catch(e){
        // ignore if not supported
      }
      // clear previous timer
      if(typingTimer) clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>{
        // set false (or remove)
        remove(ref(db, 'typing/' + USER_KEY)).catch(()=>{});
      }, 1200);
    }

    /* ====== Sending messages ====== */
    function sendMessage(){
      const text = msgInput.value.trim();
      if(!text) return;
      const payload = { name: DISPLAY_NAME, text: text, ts: nowTs() };
      push(messagesRef, payload).then(()=>{
        // provide small sent animation
        createLocalBubble(payload, true);
      }).catch(err=>{
        console.error('Gönderme hatası', err);
        alert('Mesaj gönderilemedi. Konsolu kontrol et.');
      });
      msgInput.value = '';
      // clear typing immediately
      remove(ref(db, 'typing/' + USER_KEY)).catch(()=>{});
    }

    /* ====== DOM helpers ====== */
    function createLocalBubble(data, isMe){
      // This is to give instant UX while onChildAdded will also append (duplicates possible).
      // To avoid duplicates we won't append a second time because onChildAdded will do it.
      // But for snappier feedback we can scroll to bottom and play a send animation
      messagesEl.scrollTop = messagesEl.scrollHeight;
      // Add brief pulse to send button
      sendBtn.animate([{ transform:'scale(1.0)'},{ transform:'scale(0.96)'},{ transform:'scale(1.0)'}],{ duration: 220 });
    }

    // track last shown message keys to prevent duplicates when creating local UI (we rely solely on onChildAdded)
    const shownMessages = new WeakMap();

    function addMessageToDOM(data){
      if(!data || !data.text) return;
      // create elements
      const isMe = data.name === DISPLAY_NAME;
      const row = document.createElement('div');
      row.className = 'msg-row' + (isMe ? ' me' : '');

      if(!isMe){
        const av = document.createElement('div');
        av.className = 'avatar-sm';
        av.textContent = avatarLetter(data.name);
        row.appendChild(av);
      }

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (isMe ? 'me' : 'other');

      const who = document.createElement('div');
      who.className = 'who';
      who.textContent = isMe ? 'Sen' : (data.name || 'Anonim');

      const txt = document.createElement('div');
      txt.className = 'text';
      txt.innerHTML = escapeHtml(data.text).replace(/\n/g, '<br>');

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = formatTime(data.ts);

      bubble.appendChild(who);
      bubble.appendChild(txt);
      bubble.appendChild(time);

      row.appendChild(bubble);

      if(isMe){
        const spacer = document.createElement('div');
        spacer.style.width = '36px';
        row.appendChild(spacer);
      }

      messagesEl.appendChild(row);
      // auto scroll with smooth effect
      messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });

      // remove empty hint if present
      if(emptyHint) emptyHint.style.display = 'none';
    }

    /* ====== Small UX niceties ====== */
    // allow pressing Ctrl+Enter for newline
    msgInput.addEventListener('keydown', e => {
      if(e.key === 'Enter' && e.ctrlKey){ msgInput.value += '\n'; }
    });

    // optional: show last X messages loaded automatically (Realtime DB onChildAdded with query gives all existing)
    // No further action needed.

    /* ====== Cleanup on page unload ====== */
    window.addEventListener('beforeunload', () => {
      if(db && USER_KEY){
        try{ remove(ref(db, 'typing/' + USER_KEY)); }catch(e){}
      }
    });

    /* ====== Accessibility: focus on name input on load ====== */
    window.addEventListener('load', () => {
      nameInput.focus();
    });
  </script>
</body>
</html>