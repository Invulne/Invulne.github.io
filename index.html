<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Discord Tarzı Voice Chat</title>
<style>
/* Temel Reset */
* { box-sizing: border-box; margin:0; padding:0; }

body { font-family: 'Segoe UI', sans-serif; background: #2f3136; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

header { width: 100%; background: #202225; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }

#link { margin: 15px; color: #00b0f4; word-break: break-all; text-align: center; }

#container { display: flex; width: 90%; max-width: 1000px; flex:1; margin-top:10px; }

#sidebar { width: 250px; background: #36393f; border-radius: 10px; padding: 15px; display:flex; flex-direction: column; }

#users { flex:1; overflow-y:auto; }

.user { padding: 8px; border-bottom: 1px solid #4f545c; display:flex; justify-content: space-between; align-items:center; transition: all 0.3s; }

.user.online::before { content:"●"; color:#3ba55c; margin-right:5px; }

.user.offline::before { content:"●"; color:#f04747; margin-right:5px; }

#main { flex:1; margin-left: 15px; background: #40444b; border-radius:10px; padding:20px; display:flex; flex-direction: column; align-items:center; }

#audioControls { margin-bottom:20px; display:flex; flex-direction: column; align-items:center; }

#audioControls select, #audioControls button { margin:5px; padding:10px; font-size:16px; border-radius:5px; border:none; cursor:pointer; }

#audios audio { margin: 5px auto; width: 250px; border-radius:5px; }

</style>
</head>
<body>

<header>Discord Tarzı Voice Chat</header>

<div id="link"></div>

<div id="container">
    <div id="sidebar">
        <h3>Katılımcılar</h3>
        <div id="users"></div>
    </div>
    <div id="main">
        <div id="audioControls">
            <select id="micSelect"></select>
            <button id="joinBtn">Odaya Katıl</button>
            <button id="toggleMic">Mikrofonu Kapat</button>
        </div>
        <div id="audios"></div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
const joinBtn = document.getElementById('joinBtn');
const toggleMicBtn = document.getElementById('toggleMic');
const micSelect = document.getElementById('micSelect');
const audiosDiv = document.getElementById('audios');
const usersDiv = document.getElementById('users');
const linkDiv = document.getElementById('link');

let localStream;
let peer;
let connections = {};
let micOn = true;
let myId;

// Oda ID
let urlParams = new URLSearchParams(window.location.search);
let roomId = urlParams.get('room');
if (!roomId) roomId = Math.random().toString(36).substring(2,10);

// Kullanıcı listesi (demo)
function updateUsers() {
    let peers = JSON.parse(localStorage.getItem('room-' + roomId) || "[]");
    usersDiv.innerHTML = "";
    peers.forEach(p => {
        const div = document.createElement('div');
        div.className = "user online";
        div.innerText = p;
        usersDiv.appendChild(div);
    });
}

// Ses elementleri
function addAudio(stream, peerId) {
    if(document.getElementById('audio-'+peerId)) return;
    const audio = document.createElement('audio');
    audio.id = 'audio-'+peerId;
    audio.autoplay = true;
    audio.srcObject = stream;
    audiosDiv.appendChild(audio);
}

// Mikrofonları listele
async function listMics() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    micSelect.innerHTML = "";
    devices.filter(d=>d.kind==="audioinput").forEach((device,i)=>{
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Mikrofon ${i+1}`;
        micSelect.appendChild(option);
    });
}

// Peer başlat
async function initPeer() {
    const selectedMic = micSelect.value;
    localStream = await navigator.mediaDevices.getUserMedia({ audio: { deviceId: selectedMic ? { exact: selectedMic } : undefined } });
    
    peer = new Peer(undefined, { debug:2 });

    peer.on('open', id => {
        myId = id;
        linkDiv.innerHTML = `Oda linki: <a href="?room=${roomId}" target="_blank">${window.location.origin}?room=${roomId}</a>`;
        joinRoom(id);
    });

    peer.on('call', incomingCall => {
        incomingCall.answer(localStream);
        incomingCall.on('stream', remoteStream => addAudio(remoteStream, incomingCall.peer));
    });
}

// Odaya katıl
function joinRoom(myId){
    let peers = JSON.parse(localStorage.getItem('room-'+roomId) || "[]");
    peers.forEach(peerId=>{
        if(peerId!==myId){
            const call = peer.call(peerId, localStream);
            call.on('stream', remoteStream=>addAudio(remoteStream, peerId));
            connections[peerId]=call;
        }
    });
    if(!peers.includes(myId)) peers.push(myId);
    localStorage.setItem('room-'+roomId, JSON.stringify(peers));
    updateUsers();
}

// Mikrofon aç/kapa
toggleMicBtn.onclick = ()=>{
    if(!localStream) return;
    localStream.getAudioTracks()[0].enabled = !micOn;
    micOn = !micOn;
    toggleMicBtn.innerText = micOn ? "Mikrofonu Kapat" : "Mikrofonu Aç";
}

// Odaya katıl
joinBtn.onclick = initPeer;

// Mikrofonları listele
listMics();
micSelect.onchange = ()=>{ if(localStream) initPeer(); }

// Her 2 saniyede kullanıcı listesi güncelle
setInterval(updateUsers, 2000);

</script>

</body>
</html>

