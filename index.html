<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Almanca AkÄ±llÄ± Okuma</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 25px;
  }

  textarea {
    width: 100%;
    height: 120px;
    font-size: 16px;
  }

  button {
    margin-top: 10px;
    padding: 8px 14px;
    font-size: 16px;
    cursor: pointer;
  }

  .text {
    margin-top: 25px;
    font-size: 18px;
    line-height: 1.9;
  }

  .word {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 4px;
  }

  .word:hover {
    background: #e6f2ff;
  }

  /* Mini kart */
  .card {
    position: absolute;
    background: #fff;
    border-radius: 10px;
    padding: 12px 14px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    font-size: 15px;
    z-index: 1000;
    max-width: 220px;
  }
</style>
</head>
<body>

<h2>ðŸ‡©ðŸ‡ª Almanca Metni YapÄ±ÅŸtÄ±r</h2>

<textarea id="inputText">
Der Mann liest ein Buch. Die BÃ¼cher sind interessant.
</textarea><br>
<button onclick="processText()">Metni HazÄ±rla</button>

<div class="text" id="output"></div>

<script>
/* =======================
   CACHE
======================= */
const cache = {};

/* =======================
   NORMALIZE (basit ama iÅŸe yarar)
======================= */
function normalize(word) {
  word = word.toLowerCase();

  const exceptions = {
    liest: "lesen",
    bÃ¼cher: "buch",
    war: "sein",
    ging: "gehen"
  };

  if (exceptions[word]) return exceptions[word];

  return word
    .replace(/(ern|en|er|e|n|s)$/,"");
}

/* =======================
   TRANSLATE (FREE API)
======================= */
async function translate(word) {
  if (cache[word]) return cache[word];

  const res = await fetch("https://libretranslate.de/translate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      q: word,
      source: "de",
      target: "tr",
      format: "text"
    })
  });

  const data = await res.json();
  const result = data.translatedText || "Ã‡eviri yok";

  cache[word] = result;
  return result;
}

/* =======================
   UI
======================= */
let activeCard = null;

function showCard(target, text) {
  if (activeCard) activeCard.remove();

  const rect = target.getBoundingClientRect();
  const card = document.createElement("div");
  card.className = "card";
  card.textContent = text;

  document.body.appendChild(card);

  card.style.top = rect.bottom + window.scrollY + 8 + "px";
  card.style.left = rect.left + window.scrollX + "px";

  activeCard = card;
}

/* =======================
   PROCESS TEXT
======================= */
function processText() {
  const text = inputText.value;
  output.innerHTML = "";

  const parts = text.split(/(\s+|[.,!?])/);

  parts.forEach(part => {
    if (part.trim() === "" || /[.,!?]/.test(part)) {
      output.append(part);
    } else {
      const span = document.createElement("span");
      span.className = "word";
      span.textContent = part;

      span.onclick = async () => {
        const clean = normalize(part);
        showCard(span, "YÃ¼kleniyor...");
        const meaning = await translate(clean);
        showCard(span, `${clean} â†’ ${meaning}`);
      };

      output.append(span);
    }
  });
}

/* Kart dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapansÄ±n */
document.addEventListener("click", e => {
  if (!e.target.classList.contains("word") && activeCard) {
    activeCard.remove();
    activeCard = null;
  }
});
</script>

</body>
</html>