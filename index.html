<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>tost chat ðŸ”¥</title>
  <style>
    body { font-family: sans-serif; background: #0f1724; color: #fff; margin: 0; display: flex; flex-direction: column; align-items: center; }
    h1 { color: #06b6d4; margin-top: 20px; }
    #messages { width: 90%; max-width: 600px; height: 60vh; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; margin: 20px 0; }
    .msg { background: rgba(255,255,255,0.08); padding: 8px 10px; margin: 6px 0; border-radius: 8px; }
    .me { background: rgba(6,182,212,0.2); text-align: right; }
    textarea { width: 90%; max-width: 600px; height: 60px; border-radius: 8px; padding: 10px; resize: none; }
    button { margin-top: 8px; background: #06b6d4; color: #042027; border: none; border-radius: 8px; padding: 10px 20px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ðŸ”¥ Tost Chat</h1>
  <div id="messages"></div>
  <textarea id="msgInput" placeholder="Mesaj yaz... (Enter = GÃ¶nder)"></textarea>
  <button id="sendBtn">GÃ¶nder</button>

  <script type="module">
    const allowedIP = "78.161.238.24";

    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(data => {
        const userIP = data.ip;
        if (userIP !== allowedIP) {
          document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:50px;'>You are not my tost</h1>";
        } else {
          // ðŸ”¹ IP eÅŸleÅŸti, chat uygulamasÄ±nÄ± baÅŸlat
          initChat();
        }
      })
      .catch(err => {
        console.error("IP alÄ±namadÄ±", err);
      });

    function initChat() {
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import { getDatabase, ref, push, onChildAdded, get, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDag_mCdG-tvvbZ3Dz7bpj9pbjh5teskg8",
        authDomain: "tost-269b0.firebaseapp.com",
        databaseURL: "https://tost-269b0-default-rtdb.firebaseio.com",
        projectId: "tost-269b0",
        storageBucket: "tost-269b0.firebasestorage.app",
        messagingSenderId: "882411853999",
        appId: "1:882411853999:web:8a0eb7a9b12d3df6b2dc5a",
        measurementId: "G-12KF7R4YME"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const messagesRef = ref(db, "messages");

      const messagesDiv = document.getElementById("messages");
      const msgInput = document.getElementById("msgInput");
      const sendBtn = document.getElementById("sendBtn");
      const username = "KullanÄ±cÄ±-" + Math.floor(Math.random() * 1000);

      function escapeHtml(s) {
        return s.replace(/[&<>\"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
      }

      function addMessageToDOM(data) {
        const el = document.createElement("div");
        el.className = "msg";
        if (data.name === username) el.classList.add("me");
        el.innerHTML = `<strong>${escapeHtml(data.name)}</strong><br>${escapeHtml(data.text)}`;
        messagesDiv.appendChild(el);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      sendBtn.addEventListener("click", sendMessage);
      msgInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function sendMessage() {
        const text = msgInput.value.trim();
        if (!text) return;
        push(messagesRef, { name: username, text, ts: Date.now() });
        msgInput.value = "";
      }

      // Eski mesajlarÄ± yÃ¼kle
      get(query(messagesRef, orderByChild("ts"))).then(snapshot => {
        snapshot.forEach(snap => {
          addMessageToDOM(snap.val());
        });
      });

      // Yeni mesajlarÄ± dinle
      onChildAdded(messagesRef, snap => {
        addMessageToDOM(snap.val());
      });
    }
  </script>
</body>
</html>

